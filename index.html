<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudVideo P2P</title>
    <style>
        :root { --bg: #0b0e14; --panel: #1e293b; --accent: #3b82f6; --error: #ef4444; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        /* Видео сетка */
        .video-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 70vh; padding: 20px; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; background: #222; transform: scaleX(-1); }
        
        /* Интерфейс управления */
        .controls { height: 30vh; background: var(--panel); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; border-top: 2px solid #334155; }
        .btn-group { display: flex; gap: 10px; }
        
        button { padding: 12px 25px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-main { background: var(--accent); color: white; }
        .btn-danger { background: var(--error); color: white; }
        
        input { background: #0b0e14; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; text-align: center; width: 250px; font-family: monospace; }
        .status-tag { font-size: 14px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="video-container">
    <div>
        <div style="text-align: center; font-size: 12px; color: #555;">ВЫ</div>
        <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
        <div style="text-align: center; font-size: 12px; color: #555;">СОБЕСЕДНИК</div>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
</div>

<div class="controls">
    <div id="status" class="status-tag">Ожидание действий...</div>
    
    <div class="btn-group">
        <button class="btn-main" id="createBtn">СОЗДАТЬ КОМНАТУ</button>
        <input type="text" id="roomInput" placeholder="Введите ID комнаты">
        <button class="btn-main" style="background: #10b981;" id="joinBtn">ВОЙТИ</button>
    </div>

    <div class="btn-group">
        <button class="btn-danger" onclick="location.reload()">ЗАВЕРШИТЬ ЗВОНОК</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOmPzdDi6n6vICcDMoAytqVQ9nr9ZLERQ",
        authDomain: "notes-f9e8b.firebaseapp.com",
        databaseURL: "https://notes-f9e8b-default-rtdb.firebaseio.com",
        projectId: "notes-f9e8b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const servers = {
        iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }],
        iceCandidatePoolSize: 10,
    };

    let pc = new RTCPeerConnection(servers);
    let localStream = null;
    let remoteStream = null;

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const roomInput = document.getElementById('roomInput');
    const status = document.getElementById('status');

    // Настройка медиа
    async function setupMedia() {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        remoteStream = new MediaStream();

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        
        localVideo.srcObject = localStream;
        remoteVideo.srcObject = remoteStream;
    }

    // 1. СОЗДАТЬ ЗВОНОК
    document.getElementById('createBtn').onclick = async () => {
        await setupMedia();
        const callRef = push(ref(db, 'calls'));
        const callId = callRef.key;
        roomInput.value = callId;
        status.innerText = "Комната создана. Передайте ID другу.";

        pc.onicecandidate = event => {
            if (event.candidate) push(ref(db, `calls/${callId}/callerCandidates`), event.candidate.toJSON());
        };

        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);
        await set(ref(db, `calls/${callId}/offer`), { sdp: offerDescription.sdp, type: offerDescription.type });

        onValue(ref(db, `calls/${callId}/answer`), async snapshot => {
            const data = snapshot.val();
            if (!pc.currentRemoteDescription && data) {
                await pc.setRemoteDescription(new RTCSessionDescription(data));
                status.innerText = "Собеседник подключился!";
            }
        });

        onChildAdded(ref(db, `calls/${callId}/calleeCandidates`), snap => {
            pc.addIceCandidate(new RTCIceCandidate(snap.val()));
        });
    };

    // 2. ВОЙТИ В ЗВОНОК
    document.getElementById('joinBtn').onclick = async () => {
        const callId = roomInput.value;
        if (!callId) return alert("Введите ID комнаты!");
        await setupMedia();

        pc.onicecandidate = event => {
            if (event.candidate) push(ref(db, `calls/${callId}/calleeCandidates`), event.candidate.toJSON());
        };

        const callSnap = await (await fetch(`${firebaseConfig.databaseURL}/calls/${callId}/offer.json`)).json();
        await pc.setRemoteDescription(new RTCSessionDescription(callSnap));

        const answerDescription = await pc.createAnswer();
        await pc.setLocalDescription(answerDescription);
        await update(ref(db, `calls/${callId}`), { answer: { sdp: answerDescription.sdp, type: answerDescription.type } });

        onChildAdded(ref(db, `calls/${callId}/callerCandidates`), snap => {
            pc.addIceCandidate(new RTCIceCandidate(snap.val()));
        });

        status.innerText = "Вы подключились к звонку.";
    };
</script>
</body>
</html>
