<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School EcoSystem | Auth</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #58a6ff; --money: #39d353; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; margin: 0; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 400px; padding: 20px; display: none; }
        
        /* Экран входа */
        #auth-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        
        /* Главная панель */
        .stat-card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #30363d; margin-bottom: 15px; text-align: center; }
        .balance { font-size: 40px; font-weight: bold; color: var(--money); margin: 10px 0; }
        .system-pool { font-size: 14px; color: #8b949e; }

        button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-google { background: white; color: black; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-loot { background: var(--money); color: black; font-size: 18px; margin-top: 10px; }
        .btn-loot:disabled { background: #234d32; color: #8b949e; cursor: not-allowed; }

        .user-info { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 14px; }
        .user-info img { width: 35px; height: 35px; border-radius: 50%; }

        .input-group { background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid #30363d; margin-top: 20px; }
        input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: white; padding: 10px; border-radius: 8px; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="font-size: 32px; letter-spacing: -1px;">SCHOOL<span style="color:var(--accent)">ECO</span></h1>
        <button class="btn-google" onclick="signIn()">
            <img src="https://www.google.com/favicon.ico" width="18"> Войти через Google
        </button>
    </div>

    <div class="app" id="app-ui">
        <div class="user-info">
            <img id="user-pic" src="">
            <span id="user-name">Загрузка...</span>
            <button onclick="signOutUser()" style="width: auto; padding: 5px 10px; margin-left: auto; font-size: 10px; background: #30363d;">Выйти</button>
        </div>

        <div class="stat-card">
            <div class="system-pool">Глобальный резерв: <span id="pool-val">0.00</span> $</div>
            <div class="balance" id="user-balance">0.00 $</div>
            <div style="font-size: 12px; color: #8b949e;">Твой текущий баланс</div>
        </div>

        <button class="btn-loot" id="loot-btn" onclick="loot()">ЛУТАТЬ ВЫПЛАТУ (+5$)</button>

        <div class="input-group">
            <div style="font-size: 12px; color: #8b949e;">БЫСТРЫЙ ПЕРЕВОД</div>
            <input type="text" id="target-uid" placeholder="UID получателя">
            <input type="number" id="send-amount" placeholder="Сумма">
            <button onclick="transfer()" style="background: var(--accent); color: white;">ОТПРАВИТЬ</button>
        </div>
        
        <div style="margin-top: 15px; font-size: 10px; color: #484f58; word-break: break-all;">
            Твой ID для получения: <br><b id="my-uid-display"></b>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOmPzdDi6n6vICcDMoAytqVQ9nr9ZLERQ",
        authDomain: "notes-f9e8b.firebaseapp.com",
        databaseURL: "https://notes-f9e8b-default-rtdb.firebaseio.com",
        projectId: "notes-f9e8b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;

    // Авторизация
    window.signIn = () => signInWithPopup(auth, provider);
    window.signOutUser = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            showUI(user);
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    function showUI(user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-ui').style.display = 'block';
        document.getElementById('user-pic').src = user.photoURL;
        document.getElementById('user-name').innerText = user.displayName;
        document.getElementById('my-uid-display').innerText = user.uid;

        // Подписка на баланс
        onValue(ref(db, `eco/users/${user.uid}/bal`), (s) => {
            document.getElementById('user-balance').innerText = (s.val() || 0).toFixed(2) + ' $';
        });

        // Подписка на глобальный резерв
        onValue(ref(db, 'eco/system_pool'), (s) => {
            const pool = s.val() || 0;
            document.getElementById('pool-val').innerText = pool.toFixed(2);
            document.getElementById('loot-btn').disabled = pool < 5;
        });
    }

    // Логика печати денег (серверная имитация)
    setInterval(() => {
        runTransaction(ref(db, 'eco/system_pool'), (c) => (c || 0) + 0.50);
    }, 2000);

    // Функция лутания
    window.loot = () => {
        runTransaction(ref(db, 'eco/system_pool'), (pool) => {
            if (pool >= 5) {
                runTransaction(ref(db, `eco/users/${currentUser.uid}/bal`), (b) => (b || 0) + 5);
                return pool - 5;
            }
        });
    };

    // Функция перевода
    window.transfer = async () => {
        const to = document.getElementById('target-uid').value;
        const amt = parseFloat(document.getElementById('send-amount').value);
        if (!to || amt <= 0) return;

        const myRef = ref(db, `eco/users/${currentUser.uid}/bal`);
        const result = await runTransaction(myRef, (bal) => {
            if (bal >= amt) return bal - amt;
        });

        if (result.committed) {
            runTransaction(ref(db, `eco/users/${to}/bal`), (b) => (b || 0) + amt);
            alert("Деньги отправлены!");
        } else {
            alert("Недостаточно средств!");
        }
    };
</script>
</body>
</html>
