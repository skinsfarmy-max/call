<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map Sync Pro</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0f172a; color: white; font-family: sans-serif; overflow: hidden; }
        #setup { position: fixed; inset: 0; z-index: 100; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        input { padding: 15px; border-radius: 12px; border: 1px solid #334155; background: #1e293b; color: white; width: 250px; text-align: center; }
        button { padding: 15px 30px; border-radius: 12px; border: none; background: #3b82f6; color: white; font-weight: bold; cursor: pointer; }
        
        #map-wrapper { display: none; width: 100%; height: 100%; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* Слой для отлова кликов */
        #click-layer { position: absolute; inset: 0; z-index: 5; background: transparent; cursor: crosshair; display: none; }
        
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(30, 41, 59, 0.9); padding: 10px; border-radius: 15px; display: flex; gap: 10px; }
        .hint { position: absolute; top: 10px; width: 100%; text-align: center; z-index: 10; pointer-events: none; text-shadow: 0 2px 4px black; }
    </style>
</head>
<body>

<div id="setup">
    <h1>MAP SYNC</h1>
    <button onclick="start(true)">СОЗДАТЬ</button>
    <input type="number" id="rid" placeholder="ID (4 цифры)">
    <button onclick="start(false)" style="background: #10b981;">ВОЙТИ</button>
</div>

<div id="map-wrapper">
    <div class="hint">Двойной клик по экрану, чтобы сменить место для всех</div>
    <div id="click-layer" ondblclick="changePlace()"></div>
    <iframe id="map"></iframe>
    <div class="controls">
        <button onclick="toggleMode()" id="mode-btn">РЕЖИМ: ОБЗОР</button>
        <button onclick="location.reload()" style="background:#ef4444">ВЫХОД</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOmPzdDi6n6vICcDMoAytqVQ9nr9ZLERQ",
        authDomain: "notes-f9e8b.firebaseapp.com",
        databaseURL: "https://notes-f9e8b-default-rtdb.firebaseio.com",
        projectId: "notes-f9e8b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let roomId, isNavMode = false;

    window.start = (create) => {
        roomId = create ? Math.floor(1000 + Math.random() * 9000).toString() : document.getElementById('rid').value;
        if(!roomId) return alert("Введите ID");
        
        document.getElementById('setup').style.display = 'none';
        document.getElementById('map-wrapper').style.display = 'block';

        if(create) set(ref(db, `walk/${roomId}`), { p: "London" });

        onValue(ref(db, `walk/${roomId}`), (s) => {
            if(s.exists()) document.getElementById('map').src = `https://maps.google.com/maps?q=${encodeURIComponent(s.val().p)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
        });
    };

    window.toggleMode = () => {
        isNavMode = !isNavMode;
        document.getElementById('click-layer').style.display = isNavMode ? 'block' : 'none';
        document.getElementById('mode-btn').innerText = isNavMode ? 'РЕЖИМ: КЛИК' : 'РЕЖИМ: ОБЗОР';
        document.getElementById('mode-btn').style.background = isNavMode ? '#f59e0b' : '#3b82f6';
    };

    window.changePlace = () => {
        const p = prompt("Куда летим?");
        if(p) set(ref(db, `walk/${roomId}`), { p: p });
    };
</script>
</body>
</html>
