<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CloudTalk Mobile</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #10b981; --btn-join: #3b82f6; --error: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }

        .app-container { width: 90%; max-width: 400px; background: var(--card); padding: 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); text-align: center; }
        
        .avatar-area { width: 100px; height: 100px; background: #334155; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; border: 3px solid var(--accent); }
        .calling .avatar-area { animation: pulse 1.5s infinite; }

        h2 { margin: 10px 0; font-size: 24px; }
        #status { color: #94a3b8; margin-bottom: 25px; font-size: 14px; }

        .input-group { margin-bottom: 20px; }
        input { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #334155; background: #0f172a; color: white; font-size: 18px; text-align: center; outline: none; }
        input:focus { border-color: var(--accent); }

        button { width: 100%; padding: 18px; border-radius: 18px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-bottom: 12px; }
        .btn-start { background: var(--accent); color: white; }
        .btn-join { background: var(--btn-join); color: white; }
        .btn-hangup { background: var(--error); color: white; display: none; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body>

<div class="app-container" id="app">
    <div class="avatar-area">üéôÔ∏è</div>
    <h2 id="title">CloudTalk</h2>
    <div id="status">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>

    <div class="input-group">
        <input type="text" id="roomID" placeholder="ID –ö–û–ú–ù–ê–¢–´">
    </div>

    <button class="btn-start" id="btn-create">–°–û–ó–î–ê–¢–¨ –ó–í–û–ù–û–ö</button>
    <button class="btn-join" id="btn-connect">–ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø</button>
    <button class="btn-hangup" id="btn-end">–ó–ê–í–ï–†–®–ò–¢–¨</button>

    <audio id="audio-out" autoplay></audio>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOmPzdDi6n6vICcDMoAytqVQ9nr9ZLERQ",
        authDomain: "notes-f9e8b.firebaseapp.com",
        databaseURL: "https://notes-f9e8b-default-rtdb.firebaseio.com",
        projectId: "notes-f9e8b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const pc = new RTCPeerConnection({
        iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }]
    });

    let localStream = null;
    const roomInput = document.getElementById('roomID');
    const statusText = document.getElementById('status');
    const appContainer = document.getElementById('app');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–≤—É–∫–∞
    async function startAudio() {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        appContainer.classList.add('calling');
    }

    // –ü—Ä–∏–µ–º –∑–≤—É–∫–∞ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    pc.ontrack = (event) => {
        document.getElementById('audio-out').srcObject = event.streams[0];
    };

    // --- –°–û–ó–î–ê–ù–ò–ï –ó–í–û–ù–ö–ê ---
    document.getElementById('btn-create').onclick = async () => {
        const callRef = push(ref(db, 'calls'));
        const callId = callRef.key;
        roomInput.value = callId;
        statusText.innerText = "–ü–µ—Ä–µ–¥–∞–π ID –¥—Ä—É–≥—É";
        
        await startAudio();

        pc.onicecandidate = e => e.candidate && push(ref(db, `calls/${callId}/callerCandidates`), e.candidate.toJSON());

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await set(ref(db, `calls/${callId}/offer`), { sdp: offer.sdp, type: offer.type });

        onValue(ref(db, `calls/${callId}/answer`), async snap => {
            if (!pc.currentRemoteDescription && snap.exists()) {
                await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
                statusText.innerText = "–ù–∞ —Å–≤—è–∑–∏";
            }
        });

        onChildAdded(ref(db, `calls/${callId}/calleeCandidates`), snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
        uiOnCall();
    };

    // --- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ---
    document.getElementById('btn-connect').onclick = async () => {
        const callId = roomInput.value;
        if (!callId) return alert("–í—Å—Ç–∞–≤—å ID!");
        
        await startAudio();

        pc.onicecandidate = e => e.candidate && push(ref(db, `calls/${callId}/calleeCandidates`), e.candidate.toJSON());

        // –ü–æ–ª—É—á–∞–µ–º –æ—Ñ—Ñ–µ—Ä —á–µ—Ä–µ–∑ fetch (–±—ã—Å—Ç—Ä–µ–µ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è)
        const snap = await (await fetch(`${firebaseConfig.databaseURL}/calls/${callId}/offer.json`)).json();
        await pc.setRemoteDescription(new RTCSessionDescription(snap));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await update(ref(db, `calls/${callId}`), { answer: { sdp: answer.sdp, type: answer.type } });

        onChildAdded(ref(db, `calls/${callId}/callerCandidates`), snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
        statusText.innerText = "–ù–∞ —Å–≤—è–∑–∏";
        uiOnCall();
    };

    function uiOnCall() {
        document.getElementById('btn-create').style.display = 'none';
        document.getElementById('btn-connect').style.display = 'none';
        document.getElementById('btn-end').style.display = 'block';
    }

    document.getElementById('btn-end').onclick = () => location.reload();
</script>
</body>
</html>
